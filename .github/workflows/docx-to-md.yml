# .github/workflows/convert-docx-to-md.yml
name: Convert DOCX to Markdown (AST fix for image positions)

on:
  push:
    paths:
      - '**/*.docx'

permissions:
  contents: write

jobs:
  convert-docx:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install pandoc and python
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc python3 python3-pip

      - name: Convert DOCX -> pandoc JSON, fix AST, convert to Markdown
        run: |
          set -euo pipefail
          mkdir -p converted
          find . -type f -iname "*.docx" -print0 | while IFS= read -r -d '' file; do
            [ -f "$file" ] || { echo "File not found: $file"; continue; }
            filename=$(basename "$file" .docx)
            echo "Converting: $file -> converted/${filename}.md (via JSON AST)"
            (
              cd converted
              # produce pandoc JSON and extract media into filename_media
              pandoc "../$file" -f docx -t json --extract-media="${filename}_media" -o "${filename}.json"

              # fix AST: move image-only/Raw img blocks after following paragraph
              # CALL THE SCRIPT USING ../.github/scripts/... (one level up from converted -> repo root)
              python3 ../.github/scripts/fix_pandoc_ast.py "${filename}.json" "${filename}.fixed.json"

              # convert fixed JSON back to Markdown
              pandoc "${filename}.fixed.json" -f json -t gfm -o "${filename}.md"

              # cleanup intermediate json files (optional)
              rm -f "${filename}.json" "${filename}.fixed.json"
            )
          done

      - name: Commit and push converted files and media
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add converted/
          git commit -m "Auto-convert DOCX -> Markdown (fixed image positions)" || echo "No changes to commit"
          BRANCH="${GITHUB_REF#refs/heads/}"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" "HEAD:${BRANCH}"
