name: Convert DOCX to Markdown

on:
  push:
    paths:
      - '**/*.docx'

permissions:
  contents: write

jobs:
  convert-docx:
    runs-on: ubuntu-latest
    env:
      GITHUB_WORKSPACE: ${{ github.workspace }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Pre-check â€” install jq and exit early if no created/modified .docx in the push
        # Install jq first so parsing the event JSON won't fail when jq is missing.
        # This step runs BEFORE checkout to avoid doing heavy work when the push
        # only removed .docx files. It inspects commits[].added + commits[].modified
        # and exits early if there are no .docx entries (so deletions won't trigger conversion).
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          EVENT_PATH="${GITHUB_EVENT_PATH:-/github/workflow/event.json}"
          echo "GITHUB_EVENT_PATH=${EVENT_PATH}"
          # Gather added + modified files from commits[] (safe if commits missing)
          added_modified="$(jq -r '.commits[] | (.added + .modified)[]?' "$EVENT_PATH" 2>/dev/null || true)"
          echo "Files in commits[].added+modified (first 200 chars): ${added_modified:0:200}"
          has_docx=false
          while IFS= read -r f; do
            [ -z "$f" ] && continue
            case "${f,,}" in
              *.docx) has_docx=true; break ;;
            esac
          done <<EOF
$added_modified
EOF
          if [ "$has_docx" = "false" ]; then
            echo "No added/modified .docx files found in event commits[]. Exiting early (this avoids running on deletions)."
            exit 0
          fi
          echo "Found added/modified .docx in event commits[]. Proceeding with conversion."

      - name: Checkout repository (full history required for diffs)
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Install pandoc and python
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc python3 python3-pip jq

      - name: Convert changed/added DOCX files only, write md next to docx and images in <name>/images
        run: |
          set -euo pipefail
          EVENT_PATH="${GITHUB_EVENT_PATH:-/github/workflow/event.json}"
          echo "GITHUB_EVENT_PATH=$EVENT_PATH"

          # 1) Collect docx files from event commits[].added + commits[].modified (safe with spaces)
          mapfile -t changed_files < <(jq -r '.commits[] | (.added + .modified)[]?' "$EVENT_PATH" 2>/dev/null || true)

          docx_files=()
          for f in "${changed_files[@]:-}"; do
            # keep only .docx (case-insensitive)
            case "${f,,}" in
              *.docx) docx_files+=("$f") ;;
            esac
          done

          # 2) Fallback: if none found from event JSON, use git diff (null-delimited) to safely capture paths with spaces
          if [ ${#docx_files[@]} -eq 0 ]; then
            echo "No docx files found in event commits[]. Trying git diff between ${{ github.event.before }} and ${{ github.sha }} ..."
            BEFORE="${{ github.event.before }}"
            HEAD="${{ github.sha }}"
            # git diff produces NUL-separated paths with -z; --diff-filter=AM ensures only Added/Modified (no Deleted)
            while IFS= read -r -d '' p; do
              case "${p,,}" in
                *.docx) docx_files+=("$p") ;;
              esac
            done < <(git diff --name-only -z --diff-filter=AM "$BEFORE" "$HEAD" -- '*.docx' 2>/dev/null || printf '')
          fi

          if [ ${#docx_files[@]} -eq 0 ]; then
            echo "No changed .docx files detected; nothing to do."
            exit 0
          fi

          echo "DOCX files to convert:"
          for p in "${docx_files[@]}"; do printf ' - %s\n' "$p"; done

          files_to_add=()

          # 3) Process each docx preserving spaces in filenames
          for file in "${docx_files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "File not found (skipping): $file"
              continue
            fi

            dir=$(dirname "$file")
            filename=$(basename "$file" .docx)
            mdfile="${dir}/${filename}.md"
            images_target_dir="${dir}/${filename}/images"

            echo "Processing: '$file' -> md: '$mdfile' images: '$images_target_dir'"

            TMPDIR="$(mktemp -d)"
            # ensure TMPDIR is removed per-file
            cleanup() {
              rm -rf "$TMPDIR"
            }
            trap cleanup RETURN

            # Produce pandoc JSON and extract media into TMPDIR/extracted_media
            echo "Running pandoc to JSON and extracting media..."
            pandoc "$file" -f docx -t json --extract-media="${TMPDIR}/extracted_media" -o "${TMPDIR}/doc.json"

            # Fix AST if script exists
            if [ -f "${GITHUB_WORKSPACE}/.github/scripts/fix_pandoc_ast.py" ]; then
              python3 "${GITHUB_WORKSPACE}/.github/scripts/fix_pandoc_ast.py" "${TMPDIR}/doc.json" "${TMPDIR}/doc.fixed.json"
            else
              echo "Warning: AST fixer not found; using original json"
              cp "${TMPDIR}/doc.json" "${TMPDIR}/doc.fixed.json"
            fi

            # Convert fixed JSON back to Markdown, create md next to the docx (so relative links work)
            mkdir -p "$dir"
            ( cd "$dir" && pandoc "${TMPDIR}/doc.fixed.json" -f json -t gfm -o "${mdfile}" )

            # Move extracted media into desired location <dir>/<filename>/images/
            mkdir -p "${images_target_dir}"
            if [ -d "${TMPDIR}/extracted_media/media" ]; then
              # common pandoc layout
              mv "${TMPDIR}/extracted_media/media/"* "${images_target_dir}/" 2>/dev/null || true
            elif compgen -G "${TMPDIR}/extracted_media/*" >/dev/null 2>&1; then
              mv "${TMPDIR}/extracted_media/"* "${images_target_dir}/" 2>/dev/null || true
            else
              echo "No extracted media for $file"
            fi

            # Update image links inside md to point to "<filename>/images/<basename>"
            if [ -d "${images_target_dir}" ]; then
              for img in "${images_target_dir}"/*; do
                [ -e "$img" ] || continue
                base=$(basename "$img")
                # Update markdown image syntax occurrences referencing just the basename
                perl -0777 -pe "s#(\\!\\[[^\\]]*\\]\\()([^\\)\\s\"']*${base})(\\))#\$1${filename}/images/${base}\$3#g" -i "$mdfile" || true
                # Update HTML img src double and single quotes
                perl -0777 -pe "s#(<img[^>]*src=\")[^\"]*${base}(\"[^>]*>)#\$1${filename}/images/${base}\$2#gi" -i "$mdfile" || true
                perl -0777 -pe "s#(<img[^>]*src=')[^']*${base}('[^>]*>)#\$1${filename}/images/${base}\$2#gi" -i "$mdfile" || true
              done
            fi

            # Run the md-level fixer to ensure images are on their own paragraphs and blockquote-safe
            if [ -f "${GITHUB_WORKSPACE}/.github/scripts/fix_md_images.py" ]; then
              python3 "${GITHUB_WORKSPACE}/.github/scripts/fix_md_images.py" "${mdfile}" --inplace || true
            else
              echo "Warning: Markdown fixer not found; skipping md-level fix."
            fi

            # Add generated file paths to array for committing (quote paths)
            files_to_add+=("$mdfile")
            if [ -d "${images_target_dir}" ]; then
              files_to_add+=("${images_target_dir}")
            fi

            # cleanup TMPDIR now (trap RETURN will also remove)
            rm -rf "$TMPDIR"
            trap - RETURN
          done

          # 4) Commit only the generated md and image directories
          if [ ${#files_to_add[@]} -eq 0 ]; then
            echo "No generated files to add/commit."
            exit 0
          fi

          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

          for p in "${files_to_add[@]}"; do
            echo "git add -- '$p'"
            git add -- "$p" || true
          done

          git commit -m "Auto-convert changed DOCX -> Markdown (placed md next to docx; images in <name>/images)" || echo "No changes to commit"
          BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Pushing to ${BRANCH}"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}" "HEAD:${BRANCH}"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Done
        run: echo "Finished converting changed .docx files."
