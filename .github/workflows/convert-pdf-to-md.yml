name: Convert PDF to Markdown (OCR-enabled)

on:
  push:
    paths:
      - '**/*.pdf'

permissions:
  contents: write

jobs:
  convert-pdf:
    runs-on: ubuntu-latest
    env:
      OCR_LANG: "eng"
      DEBUG_KEEP_INTERMEDIATES: "false"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc poppler-utils tesseract-ocr ghostscript python3-pip
          python3 -m pip install --upgrade ocrmypdf

      - name: Convert PDFs to Markdown with OCR fallback
        run: |
          set -euo pipefail
          mkdir -p converted
          find . -type f -name "*.pdf" -print0 | while IFS= read -r -d '' file; do
            if [ ! -f "$file" ]; then
              echo "File not found: $file"
              continue
            fi

            filename=$(basename "$file" .pdf)
            echo "Processing: $file -> converted/${filename}.md"
            mkdir -p "converted/${filename}_media"

            (
              cd converted

              # Try pdftohtml first (keeps inline placement)
              if pdftohtml -c -s "../$file" "${filename}.html" >/dev/null 2>&1; then
                echo "pdftohtml succeeded for ${filename}"
                # normalize media dir names into our media folder
                for d in "${filename}.html_files" "${filename}_files" "${filename}-files"; do
                  [ -d "$d" ] && mv "$d" "${filename}_media" || true
                done
                # Convert HTML to Markdown with pandoc (extract media relative to md file)
                pandoc "${filename}.html" -f html -t gfm -o "${filename}.md" --extract-media="${filename}_media" || true
                rm -f "${filename}.html" || true
              else
                echo "pdftohtml failed; attempting OCR and text extraction"

                # Try pdftotext first
                pdftotext -layout "../$file" "${filename}.txt" >/dev/null 2>&1 || true

                # If no text, run OCR to create an OCRed PDF and extract text again
                if [ ! -s "${filename}.txt" ]; then
                  echo "Running ocrmypdf on ${file}"
                  python3 -m ocrmypdf --skip-text --rotate-pages --deskew -l "${OCR_LANG}" "../$file" "${filename}_ocr.pdf" >/dev/null 2>&1 || true
                  if [ -f "${filename}_ocr.pdf" ]; then
                    pdftotext -layout "${filename}_ocr.pdf" "${filename}.txt" >/dev/null 2>&1 || true
                  fi
                fi

                # If still no text, rasterize pages and run tesseract page-by-page
                if [ ! -s "${filename}.txt" ]; then
                  echo "Rasterizing pages and running tesseract for ${filename}"
                  pdftoppm -png -r 300 "../$file" "${filename}_page" >/dev/null 2>&1 || true
                  if ls "${filename}_page-"*.png >/dev/null 2>&1; then
                    rm -f "${filename}_ocr_pages.txt" || true
                    for img in "${filename}_page-"*.png; do
                      outbase="${img%.*}"
                      tesseract "$img" "$outbase" -l "${OCR_LANG}" quiet || true
                      if [ -f "${outbase}.txt" ]; then
                        cat "${outbase}.txt" >> "${filename}_ocr_pages.txt"
                        echo -e "\n\n" >> "${filename}_ocr_pages.txt"
                      fi
                    done
                    if [ -s "${filename}_ocr_pages.txt" ]; then
                      mv "${filename}_ocr_pages.txt" "${filename}.txt"
                    fi
                  fi
                fi

                # Extract embedded images regardless
                pdfimages -all "../$file" "${filename}_media/image" >/dev/null 2>&1 || true

                # Produce the markdown file from text or a note if no text
                if [ -s "${filename}.txt" ]; then
                  pandoc "${filename}.txt" -f markdown -t gfm -o "${filename}.md" || cp "${filename}.txt" "${filename}.md"
                else
                  echo "<!-- No text extracted from ${file} -->" > "${filename}.md"
                fi

                # If images exist but not referenced in markdown, append them at the end
                if ls "${filename}_media"/* >/dev/null 2>&1; then
                  if ! grep -q "${filename}_media/" "${filename}.md" >/dev/null 2>&1; then
                    echo -e "\n\n---\n\n### Extracted images\n" >> "${filename}.md"
                    for img in "${filename}_media"/*; do
                      echo "![](${filename}_media/$(basename "$img"))" >> "${filename}.md"
                    done
                  fi
                fi

                # cleanup OCR helper files
                rm -f "${filename}.txt" "${filename}_ocr.pdf" || true
              fi

              # remove any stray resource directories unless debugging
              if [ "${DEBUG_KEEP_INTERMEDIATES}" != "true" ]; then
                rm -rf "${filename}.html_files" "${filename}_files" "${filename}-files" 2>/dev/null || true
              else
                echo "DEBUG_KEEP_INTERMEDIATES=true - keeping intermediate files"
              fi
            )

            echo "Finished ${filename}"
          done

      - name: Commit and push converted files and media
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add converted/
          git commit -m "Auto-converted PDFs to Markdown with OCR and images" || echo "No changes to commit"
          git push https://${GH_PAT}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
