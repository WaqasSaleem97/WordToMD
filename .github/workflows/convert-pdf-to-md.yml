name: Convert PDF to Markdown

on:
  push:
    paths:
      - '**/*.pdf'

permissions:
  contents: write

jobs:
  convert-pdf:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools (pandoc, poppler-utils, OCR)
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc poppler-utils ocrmypdf tesseract-ocr

      - name: Convert PDFs to Markdown (extract images, no HTML left)
        run: |
          mkdir -p converted
          find . -type f -name "*.pdf" -print0 | while IFS= read -r -d '' file; do
            if [ -f "$file" ]; then
              filename=$(basename "$file" .pdf)
              echo "Processing $file -> converted/${filename}.md"
              mkdir -p "converted/${filename}_media"
              (
                cd converted

                # Try pdftohtml -> HTML (with images) and convert to Markdown
                if pdftohtml -c -s "../$file" "${filename}.html" >/dev/null 2>&1; then
                  # normalize potential media dirs into ${filename}_media
                  for d in "${filename}.html_files" "${filename}_files" "${filename}-files" "${filename}_files"; do
                    [ -d "$d" ] && mv "$d" "${filename}_media"
                  done

                  # Convert HTML to Markdown (GitHub-flavored) and extract media into _media
                  pandoc "${filename}.html" -f html -t gfm -o "${filename}.md" --extract-media="${filename}_media" || true
                  rm -f "${filename}.html"
                else
                  # Fallback: try text extraction + images. If no text, run OCR and retry.
                  pdftotext -layout "../$file" "${filename}.txt" >/dev/null 2>&1 || true

                  if [ -s "${filename}.txt" ]; then
                    # We have text: convert to markdown and extract embedded images
                    pandoc "${filename}.txt" -f markdown -t gfm -o "${filename}.md" || cp "${filename}.txt" "${filename}.md"
                    pdfimages -all "../$file" "${filename}_media/image" >/dev/null 2>&1 || true
                  else
                    # Try OCR then extract again
                    ocrmypdf "../$file" "${filename}_ocr.pdf" >/dev/null 2>&1 || true
                    pdftotext -layout "${filename}_ocr.pdf" "${filename}.txt" >/dev/null 2>&1 || true
                    if [ -s "${filename}.txt" ]; then
                      pandoc "${filename}.txt" -f markdown -t gfm -o "${filename}.md" || cp "${filename}.txt" "${filename}.md"
                      pdfimages -all "${filename}_ocr.pdf" "${filename}_media/image" >/dev/null 2>&1 || true
                    else
                      echo "<!-- No text extracted from ${file} -->" > "${filename}.md"
                    fi
                    rm -f "${filename}_ocr.pdf"
                  fi

                  rm -f "${filename}.txt"
                fi

                # Remove Pandoc inline image attributes like {width="..." height="..."} even if multi-line
                if [ -f "${filename}.md" ]; then
                  perl -0777 -pe 's/!\[([^\]]*)\]\(([^)]+)\)\{[^}]+\}/![\1](\2)/gs' -i "${filename}.md" || true
                fi
              )
            else
              echo "File not found: $file"
            fi
          done

      - name: Commit and push converted files and media
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add converted/
          git commit -m "Auto-converted PDFs to Markdown with images" || echo "No changes to commit"
          git push https://${GH_PAT}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
