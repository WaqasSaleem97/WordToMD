name: Convert PDF to Markdown (preserve inline images)

on:
  push:
    paths:
      - '**/*.pdf'

permissions:
  contents: write

jobs:
  convert-pdf:
    runs-on: ubuntu-latest
    env:
      OCR_LANG: "eng"                      # change if you need other language(s), e.g. "eng+spa"
      DEBUG_KEEP_INTERMEDIATES: "false"    # set to "true" to keep intermediate files for debugging

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install tools (pandoc, poppler-utils, tesseract, ghostscript, pip)
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc poppler-utils tesseract-ocr ghostscript python3-pip
          python3 -m pip install --upgrade ocrmypdf

      - name: Convert PDFs to Markdown with inline images preserved
        run: |
          set -euo pipefail
          mkdir -p converted
          find . -type f -name "*.pdf" -print0 | while IFS= read -r -d '' file; do
            [ -f "$file" ] || { echo "File not found: $file"; continue; }
            filename=$(basename "$file" .pdf)
            echo "=== Processing $file -> converted/${filename}.md ==="
            mkdir -p "converted/${filename}_media"

            (
              cd converted

              HTML_CREATED="false"

              # 1) Try pdftohtml -> HTML (keeps images inline)
              echo "Trying pdftohtml on original PDF..."
              if pdftohtml -c -s "../$file" "${filename}.html" >/dev/null 2>&1; then
                echo "pdftohtml created ${filename}.html"
                HTML_CREATED="true"
              fi

              # Normalize possible media directories (pdftohtml output variants)
              for d in "${filename}.html_files" "${filename}_files" "${filename}-files" "${filename}_files"; do
                [ -d "$d" ] && mv "$d" "${filename}_media"
              done

              # 2) If pdftohtml didn't produce HTML (likely scanned PDF), run OCR then retry pdftohtml
              if [ "$HTML_CREATED" != "true" ]; then
                echo "pdftohtml failed; trying OCR (ocrmypdf) and retrying pdftohtml..."
                ocrmypdf --skip-text --rotate-pages --deskew -l "${OCR_LANG}" "../$file" "${filename}_ocr.pdf" >/dev/null 2>&1 || true
                if [ -f "${filename}_ocr.pdf" ]; then
                  if pdftohtml -c -s "${filename}_ocr.pdf" "${filename}.html" >/dev/null 2>&1; then
                    echo "pdftohtml succeeded on OCR'd PDF"
                    HTML_CREATED="true"
                  fi
                  # normalize media dirs created by pdftohtml on OCR'd PDF
                  for d in "${filename}.html_files" "${filename}_files" "${filename}-files" "${filename}_files"; do
                    [ -d "$d" ] && mv "$d" "${filename}_media"
                  done
                else
                  echo "ocrmypdf did not create ${filename}_ocr.pdf (or it failed)."
                fi
              fi

              # 3) If we have HTML, convert to Markdown with pandoc (extract-media keeps images referenced inline)
              if [ "$HTML_CREATED" = "true" ] && [ -f "${filename}.html" ]; then
                echo "Converting HTML -> Markdown with pandoc (extract media into ${filename}_media)..."
                pandoc "${filename}.html" -f html -t gfm -o "${filename}.md" --extract-media="${filename}_media" || true
                # Remove the HTML file now that we've converted
                rm -f "${filename}.html"
              else
                # 4) Fallback: extract images and text separately (pdfimages + pdftotext), then append images
                echo "FALLBACK: using pdfimages + pdftotext (images will be appended at end)"
                pdftotext -layout "../$file" "${filename}.txt" >/dev/null 2>&1 || true
                if [ ! -s "${filename}.txt" ] && [ -f "${filename}_ocr.pdf" ]; then
                  # try extracting text from OCR'd PDF if available
                  pdftotext -layout "${filename}_ocr.pdf" "${filename}.txt" >/dev/null 2>&1 || true
                fi

                pdfimages -all "../$file" "${filename}_media/image" >/dev/null 2>&1 || true

                if [ -s "${filename}.txt" ]; then
                  pandoc "${filename}.txt" -f markdown -t gfm -o "${filename}.md" || cp "${filename}.txt" "${filename}.md"
                else
                  echo "<!-- No text extracted from ${file} -->" > "${filename}.md"
                fi

                rm -f "${filename}.txt"
              fi

              # 5) Clean Pandoc inline image attributes like {width="..."} (handles multi-line)
              if [ -f "${filename}.md" ]; then
                perl -0777 -pe 's/!\[([^\]]*)\]\(([^)]+)\)\{[^}]+\}/![\1](\2)/gs' -i "${filename}.md" || true
              fi

              # 6) Ensure any extracted images are referenced. If pandoc/html path already produced inline references, nothing to do.
              #    For the fallback path we already wrote/are appending images at the end, but leave this here to ensure visibility.
              if ls "${filename}_media"/* >/dev/null 2>&1; then
                # Check whether images are already referenced in the markdown
                if ! grep -q "${filename}_media/" "${filename}.md" >/dev/null 2>&1; then
                  echo -e "\n\n---\n\n### Extracted images\n" >> "${filename}.md"
                  for img in "${filename}_media"/*; do
                    imgname=$(basename "$img")
                    echo "![](${filename}_media/${imgname})" >> "${filename}.md"
                  done
                fi
              fi

              # 7) Remove intermediates unless debug is enabled
              if [ "${DEBUG_KEEP_INTERMEDIATES}" != "true" ]; then
                rm -f "${filename}_ocr.pdf" || true
                # pdftohtml's extra dirs were moved to ${filename}_media above, remove any stray html_files if present
                rm -rf "${filename}.html_files" "${filename}_files" "${filename}-files" || true
              else
                echo "DEBUG_KEEP_INTERMEDIATES=true â€” keeping intermediate files in converted/ for inspection"
              fi
            )

            echo "=== Finished ${filename} ==="
          done

      - name: Commit and push converted files and media
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add converted/
          git commit -m "Auto-converted PDFs to Markdown with inline images where possible" || echo "No changes to commit"
          git push https://${GH_PAT}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
